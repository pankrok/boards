let startTime,endTime,currentX,currentY,initialX,initialY,dragItem=document.querySelector("#boards-messenger"),container=document.getElementsByTagName("body")[0],moveHandler=!1,autocompleteinclude=!1,h=document.documentElement.clientHeight,w=document.documentElement.clientWidth/2,active=!1,xOffset=0,yOffset=0,currentConversationId=0,currentLastMessageId=0,unread=0,messengerSnippet=document.getElementById("boards-messenger-snippet"),messageIco=document.querySelector("#messenger-ico"),msgCloseBtn=document.querySelector("#msg-close-btn"),messengerList=document.querySelectorAll("[data-msg-list-id]"),messengerChat=document.querySelector(".direct-chat-messages"),messengerChatButton=document.getElementById("msg-chat-btn"),messengerChatInput=document.getElementById("msg-chat-input"),messengerNewMessages=[],messengerLastEl=null,listBtn=document.getElementById("msg-list-btn"),list=document.getElementById("msg-list"),managerBtn=document.getElementById("msg-manager-btn"),manager=document.getElementById("msg-manager"),msgStartChatBtn=document.getElementById("msg-start-chat"),messengerBadges=document.querySelectorAll(".msg-badge"),newMessageWork=!1;function start(){startTime=new Date}function end(){let e=(endTime=new Date)-startTime;return Math.round(e)}function dragStart(e){start(),"touchstart"===e.type?(initialX=e.touches[0].clientX-xOffset,initialY=e.touches[0].clientY-yOffset):(initialX=e.clientX-xOffset,initialY=e.clientY-yOffset),e.target===dragItem&&(active=!0)}function dragEnd(e){initialX=currentX,initialY=currentY,Math.abs(w+currentX)<70&&Math.abs(currentY)<40?(B.hide("#boards-messenger"),B.hide("#boards-messenger-snippet"),localStorage.setItem("msg","hide"),xOffset=currentX=0,yOffset=currentY=0,setTimeout(function(){setTranslate(currentX,currentY,document.getElementById("boards-messenger")),document.querySelector("#boards-messenger").classList.remove("x")},500)):(xOffset=currentX=0,yOffset=currentY=0,document.querySelector("#boards-messenger").classList.add("boards-messenger-smooth"),setTimeout(function(){setTranslate(currentX,currentY,document.getElementById("boards-messenger"))},100)),active=!1,end()<500&&"boards-messenger"===e.target.id&&("show"===messengerSnippet.getAttribute("data-visibility")?B.hide(messengerSnippet):B.show(messengerSnippet))}function drag(e){active&&(e.preventDefault(),"touchmove"===e.type?(currentX=e.touches[0].clientX-initialX,currentY=e.touches[0].clientY-initialY):(currentX=e.clientX-initialX,currentY=e.clientY-initialY),xOffset=currentX,yOffset=currentY,Math.abs(w+currentX)<70&&Math.abs(currentY)<40?document.querySelector("#boards-messenger").classList.add("x"):document.querySelector("#boards-messenger").classList.remove("x"),setTranslate(currentX,currentY,dragItem))}function setTranslate(e,t,s){s.style.transform="translate3d("+e+"px, "+t+"px, 0)"}function setConversation(e){messengerSnippet.setAttribute("data-converation-id",e),localStorage.setItem("data-converation-id",e)}function postMessage(){let e=messengerSnippet.getAttribute("data-converation-id");B.ajax({method:"POST",url:ajaxUrl,data:{module:"messenger",route:"post",cid:e,body:messengerChatInput.value},dataType:"json"}).then(e=>{messengerChatInput.value="",B.appendHtml(messengerChat,JSON.parse(e).html);let t=document.querySelectorAll(".direct-chat-msg");t=t[t.length-1].offsetTop,messengerChat.scroll({top:t,behavior:"smooth"})})}function drawConverstaion(e){B.ajax({method:"POST",url:ajaxUrl,data:{module:"messenger",route:"get",cid:e},dataType:"json"}).then(e=>{B.appendHtml(messengerChat,JSON.parse(e).html),setTimeout(function(){let e=document.querySelectorAll(".direct-chat-msg");e=e[e.length-1].offsetTop,messengerChat.scroll({top:e,behavior:"smooth"})},100)})}function messengerCheck(){B.ajax({method:"POST",url:ajaxUrl,data:{module:"messenger",route:"check",id:1,cid:1},dataType:"json",success:function(e){e.length>0?messagesCount!==e.length&&(msgList(),messagesCount=e.length,messengerBadges.forEach(function(e){e.classList.remove("d-none"),e.innerHTML=messagesCount,msgList()})):messagesCount>0&&(messagesCount=0,messengerBadges.forEach(function(e){e.classList.add("d-none"),e.innerHTML=messagesCount})),setTimeout(function(){messengerCheck()},1e4)}})}function msgList(){B.ajax({method:"POST",url:ajaxUrl,data:{module:"messenger",route:"list"},dataType:"json",success:function(e){let t=document.getElementById("msg-list-ul");t.innerHTML="",B.appendHtml(t,e),setTimeout(function(){for(item of messengerList=document.querySelectorAll("[data-msg-list-id]"))item.addEventListener("click",function(){let e=this.getAttribute("data-msg-list-id");list.classList.remove("direct-chat-contacts-open"),manager.classList.remove("direct-chat-contacts-open"),messengerChat.innerHTML="",setConversation(e),drawConverstaion(e),setTimeout(function(){let e=document.getElementsByClassName("direct-chat-msg");e.length>0&&(messengerLastEl=e[e.length-1].getAttribute("data-messageid")),!1===newMessageWork&&(getNewMessage(),newMessageWork=!0)},5e3)})},100)}})}function getNewMessage(){B.ajax({method:"POST",url:ajaxUrl,data:{module:"messenger",route:"getNew",mid:messengerLastEl,cid:messengerSnippet.getAttribute("data-converation-id")},dataType:"json",success:function(e){if(console.log(e.length),0!==e.length){B.appendHtml(messengerChat,e.html),messengerLastEl=e.id;let t=document.querySelector('[data-messageid="'+messengerLastEl+'"]').offsetTop;messengerChat.scroll({top:t,behavior:"smooth"})}setTimeout(function(){getNewMessage()},5e3)}})}function messengerUsers(){B.getScript(assets+"/scripts/autoComplete.min.js"),B.ajax({method:"POST",url:ajaxUrl,data:{module:"messenger",route:"find"},dataType:"json"}).then(e=>{B.appendHtml("#msg-userlist",JSON.parse(e));let t=document.getElementById("msg-find-user"),s=document.querySelectorAll("[data-un]");msgStartChatBtn.addEventListener("click",function(e){let t={};e.preventDefault(),document.querySelectorAll("[data-msg-checkbox]").forEach(function(e,s){e.checked&&(t[s]=e.value)}),B.ajax({method:"POST",url:ajaxUrl,data:{module:"messenger",route:"start",users:JSON.stringify(t)},dataType:"json",success:function(e){list.classList.remove("direct-chat-contacts-open"),manager.classList.remove("direct-chat-contacts-open"),messengerChat.innerHTML="",setConversation(e.cid),drawConverstaion(e.cid),setTimeout(function(){let e=document.getElementsByClassName("direct-chat-msg");e.length>0&&(messengerLastEl=e[e.length-1].getAttribute("data-messageid")),getNewMessage()},5e3)}})}),t.addEventListener("keyup",function(e){let t=document.querySelectorAll('[data-un^="'+e.target.value+'"]');console.log({find:e.target.value}),e.target.value.length>0?(s.forEach(function(e){e.classList.add("d-none")}),t.forEach(function(e){e.classList.remove("d-none")})):s.forEach(function(e){e.classList.remove("d-none")})})})}function initMessenger(){let e=!1;msgList(),messengerCheck(),listBtn.addEventListener("click",function(){list.classList.toggle("direct-chat-contacts-open"),manager.classList.remove("direct-chat-contacts-open")}),managerBtn.addEventListener("click",function(){!1===e&&(e=!0,messengerUsers()),list.classList.remove("direct-chat-contacts-open"),manager.classList.toggle("direct-chat-contacts-open")}),messengerChatButton.addEventListener("click",function(e){e.preventDefault(),postMessage()}),"show"===localStorage.getItem("msg")&&(list.classList.toggle("direct-chat-contacts-open"),manager.classList.remove("direct-chat-contacts-open"),drawConverstaion(localStorage.getItem("data-converation-id")),setConversation(localStorage.getItem("data-converation-id")),B.show("#boards-messenger"),B.show("#boards-messenger-snippet"))}messagesCount=0,container.addEventListener("touchstart",dragStart,!1),container.addEventListener("touchend",dragEnd,!1),container.addEventListener("touchmove",drag,!1),container.addEventListener("mousedown",dragStart,!1),container.addEventListener("mouseup",dragEnd,!1),container.addEventListener("mousemove",drag,!1),messageIco.addEventListener("click",function(){"show"===dragItem.getAttribute("data-visibility")?(B.hide("#boards-messenger"),B.hide("#boards-messenger-snippet"),localStorage.setItem("msg","hide")):(B.show("#boards-messenger"),B.show("#boards-messenger-snippet"),localStorage.setItem("msg","show"))}),msgCloseBtn.addEventListener("click",function(){B.hide("#boards-messenger"),B.hide("#boards-messenger-snippet"),localStorage.setItem("msg","hide")}),bReady().then(()=>{initMessenger()});